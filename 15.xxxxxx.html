@extends('app')
@section('title', '膳食管理系统 - 搭配管理')
@section('css')
    <link rel="stylesheet" href="{{asset('css/foodMatch.css')}}">
@endsection
@section('content')
    <div class="row p-t-1">
        <div class="col-md-2"><h5>搭配列表</h5></div>
    </div>
    <div class="row p-y-1">
        <form class="col-md-12 form-inline" action="" method="get">
            <span>搭配类别：</span>
            <select class="form-control" name="class" id="j-class">
                <option value="-1">全部</option>
            </select>
            <span>总能量区间：</span>
            <input type="text" class="form-control input-width" name="energy_floor" id="j-energy-floor" placeholder="最小值">
            <span>~</span>
            <input type="text" class="form-control input-width" name="energy_ceil" id="j-energy-ceil" placeholder="最大值">
            <input type="text" class="form-control" placeholder="请输入所需主料食材" name="m_primary_food" id="j-m-primary-food">
            <input type="text" class="form-control" placeholder="请输入搭配名称" name="name" id="j-name">
            <label class="m-r-1">
                <input type="radio" name="isvalid" class="form-control">
                只显示未禁用
            </label>
            <input type="button" id='searchMenus' class="btn btn-warning pull-right" value="查询">
        </form>
    </div>
    <div class="row b-t-1 p-y-1">
        <div class="col-md-12 form-inline">
            <button type="button" class="btn btn-warning" data-toggle="modal" data-target="#myModal" id="j-add-match-ma">
                添加搭配
            </button>
            <input type="button" class="btn btn-warning pull-right j-batch-forbidden" value="批量禁用">
        </div>
    </div>
    <div class="row">
        <div class="col-md-12">
            <table border="1">
                <thead>
                <tr>
                    <th>全选<input type="checkbox" id="select-all"/></th>
                    <th>搭配ID</th>
                    <th>搭配学名</th>
                    <th>类别</th>
                    <th>总能量<br/>kcal/100g</th>
                    <th>禁食疾病</th>
                    <th>宜食疾病</th>
                    <th>禁忌孕期</th>
                    <th width="22%">所需食材主料</th>
                    <th>操作</th>
                    <th>是否<br/>可用</th>
                    <th>点赞数</th>
                    <th>浏览数</th>
                    <th>图片</th>
                </tr>
                </thead>
                <tbody id="j-match-list">
                </tbody>
            </table>
        </div>
    </div>
    <div class="row p-y-2">
        <div class="col-md-12">
            <div id="pagination"></div>
        </div>
    </div>
@endsection

@section('layer')
    <!-- 点击修订弹出弹出框  -->
    <div class="layer-modify">
        <div class="layer-opacity"></div>
        <div class="layer-modify-content p-a-1">
            <div class="title-bar clearfix">
                <h4 class="pull-left">搭配名：<i class="match-name"></i></h4>
                <button class="btn btn-warning pull-right j-close-btn"><i class="fa fa-close"></i></button>
            </div>
            <div class="need-food-meterial m-t-1">
                <div class="title-bar clearfix m-b-1">
                    <h5 class="pull-left">所需食材</h5>
                    <button class="btn btn-warning pull-right j-add-fm-btn"><i class="fa fa-plus"></i>&nbsp;添加食材</button>
                </div>
                <table border="1" id="food-block">
                    <thead>
                    <tr>
                        <th>序号</th>
                        <th>食材ID</th>
                        <th>食材名称</th>
                        <th>重量（g）</th>
                        <th>是否主料</th>
                        <th>删除</th>
                    </tr>
                    </thead>
                    <tbody id="j-fm-list">
                    {{--<tr>--}}
                    {{--<td>1</td>--}}
                    {{--<td>土豆</td>--}}
                    {{--<td contenteditable="true">200</td>--}}
                    {{--<td><input type="checkbox"></td>--}}
                    {{--<td class="text-style j-edit-fm-btn">编辑</td>--}}
                    {{--<td><i class="fa fa-close cursor-type j-del-fm-btn"></i></td>--}}
                    {{--</tr>--}}
                    </tbody>
                </table>
                <h5 class="m-t-1">计算营养值</h5>
                <table border="1">
                    <tr class="bg-warning">
                        <th>能量</th>
                        <th>蛋白质</th>
                        <th>脂肪</th>
                        <th>碳水化合物</th>
                        <th>维生素A</th>
                        <th>维生素B1</th>
                        <th>维生素B2</th>
                    </tr>
                    <tr>
                        <td id="energy"></td>
                        <td id="protein"></td>
                        <td id="fat"></td>
                        <td id="carbohydrate"></td>
                        <td id="vitamin_a"></td>
                        <td id="vitamin_b1"></td>
                        <td id="vitamin_b2"></td>
                    </tr>
                    <tr class="bg-warning">
                        <th>钙</th>
                        <th>铁</th>
                        <th>锌</th>
                        <th>叶酸</th>
                        <th>维生素C</th>
                        <th>维生素D</th>
                        <th></th>
                    </tr>
                    <tr>
                        <td id="ca"></td>
                        <td id="fe"></td>
                        <td id="zn"></td>
                        <td id="folacin"></td>
                        <td id="vitamin_c"></td>
                        <td id="vitamin_d"></td>
                        <td></td>
                    </tr>
                </table>
                <div class="clearfix">
                    <h5 class="m-t-1 form-inline pull-left">总能量kcal/100g：<i id="total-energy"></i>&nbsp;修正能量kcal/100g：<input type="text" class="form-control input-width" id="j-modify-energy"></h5>
                    <button class="btn btn-warning pull-right m-t-1" id="j-save-fm-btn">保存</button>
                </div>
            </div>
            <div class="layer-edit-fm">
                <div class="layer-opacity"></div>
                <div class="layer-edit-fm-content p-a-1">
                    <div class="clearfix">
                        <div class="search-name pull-left pos-rel">
                            <div>
                                <input type="text" class="form-control" id="j-fm-name" placeholder="请输入搭配名">
                                <input type="hidden" id="add-f-id" />
                            </div>
                            <ul id="j-f-name-list" class="list-group pos-abs f-name-list">
                            </ul>
                        </div>
                        <div class="form-inline pull-right">
                            <input type="text" class="form-control input-width" id="j-fm-weight">
                            <span>g</span>
                            <select class="form-control" id="j-fm-type">
                                <option value="1">主料</option>
                                <option value="0">辅料</option>
                            </select>
                        </div>
                    </div>
                    <div class="form-inline m-t-3 p-y-3">
                        <input type="button" class="btn btn-warning pull-right m-l-1 j-fm-confirm-btn" value="确定">
                        <input type="button" class="btn btn-warning pull-right j-fm-cancel-btn" value="取消">
                    </div>
                </div>
            </div>
        </div>
    </div>
    <div class="modal fade" id="myModal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                        <span class="sr-only">Close</span>
                    </button>
                    <h4 class="modal-title" id="myModalLabel">编辑搭配信息</h4>
                </div>
                <div class="modal-body">
                    <div class="row" id="j-edit-match-info">
                        <div class="col-md-12">
                            <table border= "1" id="j-match-wrap">
                                <tr height="30px">
                                    <td width= "12% ">搭配编号：</td>
                                    <td id="j-code"></td>
                                    <td rowspan="5" width="18%" class="img-wrap">
                                        <img src="" id="j-img-show" />
                                        <form class="upload-img-wrap" id="j-img-form" method="post" action="{{url('/uploadPicture')}}" enctype="multipart/form-data">
                                            {{ csrf_field() }}
                                            <input type="hidden" name="flag" value="2">
                                            <input type="hidden" name="id" id="j-m-id">
                                            <input class="click-upload-img-btn" type="submit" value="上传图片">
                                            <input type="file" class="upload-file" name="picture" id="j-up-img" />
                                        </form>
                                    </td>
                                </tr>
                                <tr height="40px">
                                    <td width= "12% ">*学名：</td>
                                    <td contenteditable="true" id="j-match-name"></td>
                                </tr>
                                <tr height="40px">
                                    <td width= "12% ">别名：</td>
                                    <td contenteditable="true" id="j-match-alias"></td>
                                </tr>
                                <tr height="40px">
                                    <td width= "12% ">*类别：</td>
                                    <td>
                                        <select class="form-control" style="width:auto !important;" id="j-match-class">
                                        </select>
                                    </td>
                                </tr>
                                <tr height="40px">
                                    {{--<td width= "12% ">*是否禁用：</td>--}}
                                    {{--<td><label for="is-forbidden" class="form-inline"><input type="checkbox" class="form-control" id="is-forbidden">是否禁用</label></td>--}}
                                </tr>
                                <tr>
                                    <td width= "12% ">禁食疾病：</td>
                                    <td id="j-desease-dismatch">
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="11">糖尿病</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="4">高血压</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="12">母乳</label>
                                    </td>
                                    <td>
                                        <a href="javascript:;"  class="j-select-all">全选</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">宜食疾病：</td>
                                    <td id="j-desease-match">
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="14">缺铁性贫血</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="4">高血压</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="12">母乳</label>
                                    </td>
                                    <td>
                                        <a href="javascript:;" class="j-select-all">全选</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">禁忌孕期：</td>
                                    <td id="j-pregnant">
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="8">备孕</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="1">孕前期</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="2">孕中期</label>
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="3">孕后期</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="9">月子期</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="10">产后</label>
                                    </td>
                                    <td>
                                        <a href="javascript:;" class="j-select-all">全选</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td colspan="3">
                                        <hr/>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">*搭配口味：</td>
                                    <td id="j-taste">
                                        <label class="form-inline"><input type="checkbox" class="form-control">酸</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control">甜</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control">苦</label>
                                        <label class="form-inline"><input type="checkbox" class="form-control">辣</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control">咸</label>
                                    </td>
                                    <td>
                                        <a href="javascript:;" class="j-select-all">全选</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">*搭配餐时：</td>
                                    <td id="j-eat">
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="1">早</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="2">早加</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="3">午</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="4">午加</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="5">晚</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="6">晚加</label>
                                    </td>
                                    <td>
                                        <a href="javascript:;" class="j-select-all">全选</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">搭配菜系：</td>
                                    <td id="j-cook">
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="1">粤</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="2">川</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="3">鲁</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="4">苏</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="5">浙</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="6">闽</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="7">湘</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="8">徽</label>&nbsp;
                                        <label class="form-inline"><input type="checkbox" class="form-control" value="9">其他</label>
                                    </td>
                                    <td>
                                        <a href="javascript:;" class="j-select-all">全选</a>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">简介：</td>
                                    <td colspan="2">
                                        <textarea class="form-control" id="j-abstract"></textarea>
                                    </td>
                                </tr>
                                <tr height="70px">
                                    <td width= "12% ">*标签：</td>
                                    <td colspan="2" class="clearfix">
                                        <ul class="list-group pull-left" id="j-tag-name-list">
                                            {{--<li class="pull-left list-group-item b-a m-r-1">--}}
                                                {{--<span class="m-r-1 j-tag-name">健身</span>--}}
                                                {{--<i class="fa fa-close hand-gesture j-del-tag"></i>--}}
                                            {{--</li>--}}
                                        </ul>
                                        <div class="pull-left m-t-1 add-tag-layer">
                                            <i class="fa fa-plus b-a text-warning hand-gesture" id="j-add-tag"></i>
                                            <div class="search-wrap b-a p-a-2 bg-warning p-b-0" id="j-add-tag-pop">
                                                <div class="search-res">
                                                    <input type="text" class="form-control" placeholder="请输入标签关键字" id="j-search-tag" />
                                                    <input type="hidden" />
                                                    <ul class="tag-list list-group" id="j-tag-list">
                                                        {{--<li class="list-group-item hand-gesture text-muted">111111</li>--}}
                                                    </ul>
                                                </div>
                                                <div class="m-t-1 clearfix">
                                                    <button type="button" class="btn btn-primary pull-right m-l-1" id="j-confirm-add-tag">确认</button>
                                                    <button type="button" class="btn btn-secondary pull-right" id="j-cancel-add-tag">取消</button>
                                                </div>
                                            </div>
                                        </div>
                                    </td>
                                </tr>
                                {{--<tr>--}}
                                    {{--<td width= "12% ">*营养成分：</td>--}}
                                    {{--<td colspan="2" class="form-inline">--}}
                                        {{--<table>--}}
                                            {{--<tr>--}}
                                                {{--<th>能量（kcal）</th>--}}
                                                {{--<th>蛋白质（克）</th>--}}
                                                {{--<th>脂肪（克）</th>--}}
                                                {{--<th>碳水化合物（克）</th>--}}
                                                {{--<th>维生素A（ugRAE）</th>--}}
                                            {{--</tr>--}}
                                            {{--<tr>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                            {{--</tr>--}}
                                            {{--<tr>--}}
                                                {{--<th>维生素B1（mg）</th>--}}
                                                {{--<th>维生素B2（mg）</th>--}}
                                                {{--<th>维生素C（mg）</th>--}}
                                                {{--<th>维生素D（mg）</th>--}}
                                                {{--<th>钙（mg）</th>--}}
                                            {{--</tr>--}}
                                            {{--<tr>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                            {{--</tr>--}}
                                            {{--<tr>--}}
                                                {{--<th>铁（mg）</th>--}}
                                                {{--<th>锌（mg）</th>--}}
                                                {{--<th>叶酸（ugDFE）</th>--}}
                                                {{--<th></th>--}}
                                                {{--<th></th>--}}
                                            {{--</tr>--}}
                                            {{--<tr>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                                {{--<td><input type="text" class="form-control input-width"></td>--}}
                                            {{--</tr>--}}
                                        {{--</table>--}}
                                    {{--</td>--}}
                                {{--</tr>--}}
                                {{--<tr>--}}
                                    {{--<td width= "12% ">所需食材：</td>--}}
                                    {{--<td colspan="2">--}}
                                        {{--<textarea class="form-control"></textarea>--}}
                                    {{--</td>--}}
                                {{--</tr>--}}
                                <tr>
                                    <td width= "12% ">做法步骤：</td>
                                    <td colspan="2">
                                        <textarea class="form-control" id="j-detail"></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">宜食原因：</td>
                                    <td colspan="2">
                                        <textarea class="form-control" id="j-match-reason"></textarea>
                                    </td>
                                </tr>
                                <tr>
                                    <td width= "12% ">禁忌原因：</td>
                                    <td colspan="2">
                                        <textarea class="form-control" id="j-dismatch-reason"></textarea>
                                    </td>
                                </tr>
                            </table>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">取消</button>
                    <button type="button" class="btn btn-primary" id="j-save-match-ma">保存</button>
                </div>
            </div>
        </div>
    </div>
    <input type="hidden" value="{{csrf_token()}}" id="_token" />
@endsection
@section('script')
<script src="{{asset('js/jquery.form.js')}}"></script>
<script src="{{asset('js/layer.js')}}"></script>
<script>

    //获取页面的token值
    var _token=$('#_token').val();

    //获取全局元素/静态页面中的元素
    var jClass=$('#j-class');     //类名
    var jEnergyFloor=$('#j-energy-floor');    //能量下限
    var jEnergyCeil=$('#j-energy-ceil');     //能量上限
    var jPrimary=$('#j-m-primary-food');     //主料食材
    var jName=$('#j-name');                  //辅料食材
    var jRadioBtn=$('input[name=isvalid]');   //是否禁用
    IsValid(jRadioBtn);

    //获取条件筛选的值
    var url=window.location.href;
    var json=urlToJson(url);

    //筛选条件显示默认的值
    jEnergyFloor.val(json.energy_floor);
    jEnergyCeil.val(json.energy_ceil);
    jPrimary.val(decodeURI(json.m_primary_food));
    jName.val(decodeURI(json.name));

    //将禁止的状态值转换成属性显示
    if(json.isvalid == 0)
    {
        jRadioBtn.attr('checked',false);
        jRadioBtn.val(0);
    }
    else
    {
        jRadioBtn.attr('checked',true);
        jRadioBtn.val(1);
    }


    //点击查询，页面跳转
    $('#searchMenus').click(function(){

        var reg=/^\d+(\.\d+)?$/;
        if(!reg.test(jEnergyFloor.val()) || !reg.test(jEnergyCeil.val()))
        {
            errorTips('请输入数字');
        }
        else{
            window.location.href="{{url('/getFoodList')}}"+'?class='+jClass.val()+'&energy_floor='+jEnergyFloor.val()+'&energy_ceil='+jEnergyCeil.val()+'&m_primary_food='+jPrimary.val()+'&name='+jName.val()+'&isvalid='+jRadioBtn.val();
        }

    });

    //加载页面内容
    $.ajax({
        url:"{{url('searchMenus')}}",
        data:{
            "_token":_token,
            "class":json.class,
            "energy_floor":json.energy_floor,
            "energy_ceil":json.energy_ceil,
            "m_primary_food":decodeURI(json.m_primary_food),
            "name":decodeURI(json.name),
            "isvalid":json.isvalid,
            "page":json.page
        },
        dataType:"json",
        type:"post",
        success:function(data){
            if(data.status){
                errorTips(data.message);
            }else{
                goToData(data);
            }
        },
        error:function(data){
            console.log(data);
        }
    });

    //请求搭配类别
    getClassName();

    //函数0：页面加载数据
    function goToData(data)
    {
        //填充整个table的数据
        var matchList=$('#j-match-list');
        for(var i=0; i<data.data.length; i++)
        {
            //计算总能量值
            var sum=getSum(data.data[i].ma_energy,data.data[i].ma_energy_offset);

            //判断是否被禁用
            var maCheckbox='<input type="checkbox"/>';
            var maIsvalid='';
            if(data.data[i].ma_isvalid == 0)
            {
//                    maCheckbox='<input type="checkbox" checked />';
                maIsvalid='<td class="is-disabled text-danger">×</td>';
            }
            else if(data.data[i].ma_isvalid == 1){
//                    maCheckbox='<input type="checkbox"/>';
                maIsvalid='<td class="is-disabled">√</td>';
            }

            //判断是否有图片链接
            var maPhoto='';
            if(data.data[i].ma_photo)
            {
                maPhoto='<td>√</td>';
            }
            else
            {
                maPhoto='<td class="text-danger">×</td>';
            }

            //创建一行
            var tr=$('<tr><td>'+maCheckbox+'</td>'
                    +'<td class="j-ma-id">'+data.data[i].ma_id+'</td>'
                    +'<td class="j-ma-name">'+data.data[i].ma_name+'</td>'
                    +'<td>'+data.data[i].c_name+'</td>'
                    +'<td>'+sum+'</td>'
                    +'<td class="dismatch-desease">'+toJoin(data.data[i].disease_dismatch)+'</td>'
                    +'<td class="match-desease">'+toJoin(data.data[i].disease_match)+'</td>'
                    +'<td class="dismatch-pregnant">'+toJoin(data.data[i].pregnant_dismatch)+'</td>'
                    +'<td class="p-t-1"><p class="text-width pull-left j-main-food">'+toJoin(data.data[i].m_primary_food)+'</p><input type="button" value="修订" class="pull-right btn btn-warning p-a-0 j-modify-fm-btn"></td>'
                    +'<td data-toggle="modal" data-target="#myModal" class="j-modify-match-ma"><a href="javascript:;">编辑</a></td>'
                    +maIsvalid
                    +'<td>'+data.data[i].agree_amount+'</td>'
                    +'<td>478</td>'
                    +maPhoto+'</tr>');
            tr.appendTo(matchList);
        }

        //分页
        laypage({
            cont:'pagination',
            pages: data.last_page, //可以叫服务端把总页数放在某一个隐藏域，再获取。假设我们获取到的是18
            curr: function(){ //通过url获取当前页，也可以同上（pages）方式获取
                var page = location.search.match(/page=(\d+)/);
                return page ? page[1] : 1;
            }(),
            jump: function(e, first){ //触发分页后的回调
                if(!first){ //一定要加此判断，否则初始时会无限刷新
                    location.href = "{{url('/getFoodList')}}"+'?class='+jClass.val()+'&energy_floor='+jEnergyFloor.val()+'&energy_ceil='+jEnergyCeil.val()+'&m_primary_food='+jPrimary.val()+'&name='+jName.val()+'&isvalid='+jRadioBtn.val()+'&page='+e.curr;
                }
            }
        });

        //全选：牵一发而动全身
        var seltAll=$('#select-all');
        var checkboxes=$('#j-match-list input[type=checkbox]');
        selectAll(seltAll,checkboxes);


        //修订之后的。。。。。。
        var modifyFmBtn=$('.j-modify-fm-btn');   //修订
        var layerModify=$('.layer-modify');
        var layerEditFm=$('.layer-edit-fm');
        var closeBtn=$('.j-close-btn');       //关闭按钮
        var addFmBtn=$('.j-add-fm-btn');        //添加按钮
        var fmConfirmBtn=$('.j-fm-confirm-btn');    //添加食材之确定按钮
        var fmCancelBtn=$('.j-fm-cancel-btn');     //添加食材之取消按钮
        var fm=$('#j-fm');
        var weight=$('#j-fm-weight');      //修改重量
        var isPrimary=$('#j-fm-type');       //修改主辅料
        var fmList=$('#j-fm-list');
        var saveFmBtn=$('#j-save-fm-btn');      //保存能量按钮
        var modifyEnergy=$('#j-modify-energy');

        //1.1-点击修订
        modifyFmBtn.off('click').on('click',function(){
            var _this=$(this);
            layerModify.show();
            document.body.scrollTop = 0 ;
            $('body').css("overflow","hidden");   //超出body的话滚动条隐藏

            //id值
            var maId=_this.parent().parent().find('.j-ma-id').html();

            //弹框的搭配名字
            var matchName=$('.match-name');
            matchName.html(_this.parent().parent().find('.j-ma-name').html());


            //加载大弹窗里面的内容
            $.ajax({
                url:"{{url('getMenuFNE')}}",
                data:{
                    "_token":_token,
                    "id":maId
                },
                type:"POST",
                dataType:"json",
                success:function(data){
                    fmList.html('');
                    //拼接食材
                    for(var i=0; i<data.foods.length; i++)
                    {
                        var mPrimary='';
                        if(data.foods[i].m_primary == 1)
                        {
                            mPrimary = '<td><input type="checkbox" checked class="j-primary"></td>';
                        }
                        else if(data.foods[i].m_primary == 0)
                        {
                            mPrimary = '<td><input type="checkbox" class="j-primary"></td>';
                        }
                        var food=$('<tr><td>'+(i+1)+'</td>'
                                +'<td class="j-fm-id">'+data.foods[i].f_id+'</td>'
                                +'<td>'+data.foods[i].f_name+'</td>'
                                +'<td contenteditable="true" class="j-weight">'+data.foods[i].f_weight+'</td>'
                                +mPrimary
                                +'<td><i class="fa fa-close cursor-type j-del-fm-btn"></i></td></tr>');

                        fmList.append(food);
                    }

                   //拼接搭配营养成分
                    toFillData(data.nutritions);

                    //拼接总能量值
                    modifyEnergy.val(data.energy_offset);  //修正能量的填充
                    changeEnergy();   //修正能量
                    toChangeWeight();   //修改重量
                    toChangePrimary();   //修改主辅料
                    toDelFood();    //删除一条食材

                    //保存修正能量
                    saveFmBtn.off('click').on('click',function(){
                        $.ajax({
                            url:"{{url('getEnergyOffset')}}",
                            data:{
                                "_token":_token,
                                "id":maId,
                                "energy_offset":modifyEnergy.val()
                            },
                            type:"POST",
                            dataType:"json",
                            success:function(data){
                                errorTips(data.message);
                                changeEnergy();  //保存修正能量，只改变总能量
                            },
                            error:function(data){
                                console.log(data);
                            }
                        });
                    });

                    //添加食材
                    var bSelected = null;

                    getFoodName();    //搜索食材
                    fmConfirmBtn.off('click').on('click',function(){
                        var fmNum=fmList.find('tr').length+1;  //序列号
                        var reg=/^\d+(\.\d+)?$/;
                        if(!reg.test(weight.val()))
                        {
                            errorTips('食材重量不能为空，并且必须为数字类型');
                        } else if(bSelected == false)
                        {
                            errorTips('请从下拉单中选择食材');
                        }else{

                            $.ajax({
                                url:"{{url('menuModifyFood')}}",
                                data:{
                                    "_token":_token,
                                    "id":maId,
                                    "f_id":$('#add-f-id').val(),
                                    "f_weight":weight.val(),
                                    "m_primary":isPrimary.val(),
                                    "action":"MenuInsertFood"
                                },
                                type:"POST",
                                dataType:"json",
                                success:function(data){
                                    if(data.status == 0)
                                    {
                                        var td = '';
                                        if($('#j-fm-type').val() == 1)
                                        {
                                            td='<td><input type="checkbox" checked class="j-primary"></td>';
                                        }
                                        else {
                                            td='<td><input type="checkbox" class="j-primary"></td>';
                                        }
                                        var addTr=$('<tr><td>'+fmNum+'</td>'
                                                +'<td class="j-fm-id">'+$('#add-f-id').val()+'</td>'
                                                +'<td>'+$('#j-fm-name').val()+'</td>'
                                                +'<td contenteditable="true" class="j-weight">'+$('#j-fm-weight').val()+'</td>'
                                                +td
                                                +'<td><i class="fa fa-close cursor-type j-del-fm-btn"></i></td></tr>');
                                        fmList.append(addTr);
                                        layerEditFm.hide();
                                        refreshData();
                                        bSelected = false;  //置换选中状态为假
                                        errorTips(data.message);
                                    }
                                    else {
                                        errorTips(data.message);
                                    }
                                },
                                error:function(data){
                                    console.log(data);
                                }
                            });
                        }
                    });

                    //函数6：刷新能量值
                    function refreshData(){
                        $.ajax({
                            url:"{{url('refreshMenuNutritions')}}",
                            data:{
                                "_token":_token,
                                "id":maId
                            },
                            type:"POST",
                            dataType:"json",
                            success:function(data){
                                toFillData(data);
                                changeEnergy();
                            },
                            error:function(data){
                                console.log(data);
                            }
                        });
                    }

                    //函数7：改变总能量
                    function changeEnergy()
                    {
                        var sum=getSum($('#j-modify-energy').val(),$('#energy').html());
                        $('#total-energy').html(sum);
                    }

                    //函数8：填充各个能量值
                    function toFillData(json)
                    {
                        $('#energy').html(json.energy);
                        $('#protein').html(json.protein);
                        $('#fat').html(json.fat);
                        $('#carbohydrate').html(json.carbohydrate);
                        $('#vitamin_a').html(json.vitamin_a);
                        $('#vitamin_b1').html(json.vitamin_b1);
                        $('#vitamin_b2').html(json.vitamin_b2);
                        $('#ca').html(json.ca);
                        $('#fe').html(json.fe);
                        $('#zn').html(json.zn);
                        $('#folacin').html(json.folacin);
                        $('#vitamin_c').html(json.vitamin_c);
                        $('#vitamin_d').html(json.vitamin_d);
                    }

                    //函数10：请求搜索食材
                    function getFoodName()
                    {
                        var searchRes=$('#j-fm-name');

                        searchRes.on('input propertychange',function(){
                            var _this=$(this);
                            var fmNameList=$('#j-f-name-list');

                            bSelected = false;  //点击确定的时候置换选中状态为假

                            //判断一下搜索框的值是不是为空
                            if(_this.val())
                            {

                                $.ajax({
                                    url:"{{url('searchFoodMaterialByKeywords')}}",
                                    data:{
                                        "_token":_token,
                                        "f_name":_this.val()
                                    },
                                    type:"POST",
                                    dataType:"json",
                                    success:function(data){
                                        fmNameList.show();
                                        fmNameList.html('');    //每次查询都要清空
                                        var oLiFName='';
                                        if(data.foods)
                                        {
                                            //拼接搜索结果
                                            for(var i=0; i<data.foods.length; i++)
                                            {

                                                oLiFName += '<li class="list-group-item">'+data.foods[i].f_name+'<input type="hidden" value="'+data.foods[i].f_id+'" /></li>';
                                            }

                                        }
                                        else{
                                            oLiFName = '<li class="list-group-item">没有搜索到结果</li>';
                                        }
                                        fmNameList.append(oLiFName);

                                        //选中食材
                                        var perFName = $('#j-f-name-list>li');
                                        perFName.click(function(){

                                            var $this=$(this);
                                            _this.val($this.text());
                                            _this.next().val($this.find('input').val());
                                            bSelected = true;  //置换选中状态为真
                                            $this.parent().hide();
                                        });

                                    },
                                    error:function(data){
                                       console.log(data);
                                    }
                                });
                            }
                            else {
                                fmNameList.html('');
                                fmNameList.hide();
                            }

                        })
                    }


                    //函数11：改变重量
                    function toChangeWeight()
                    {
                        //将最初的重量存储起来
                        var oldWeight = 0;
                        var changeWeight = $('.j-weight');
                        changeWeight.off('focus').on('focus',function(){
                            var _this=$(this);
                            oldWeight = _this.html();
                            console.log(oldWeight);
                        });
//                        changeWeight.each(function(){
//
//                            arr.push($(this).html());
//                        });



                        // 限制输入重量只能为数字
                        $('.j-weight').off('keyup').on('keyup',function(){
                            var reg=/^[1-9]\d*(\.(?!\d*\.)\d+)*$/;
                            var _this=$(this);
                            var cont=_this.html();
                            if(!reg.test(cont))
                            {
                                _this.html('');
                            }

                        });
                        //修改能量
                        $('#j-fm-list').off('blur').on('blur','.j-weight',function(){
                            console.log(oldWeight);
                            var _this=$(this);
                            var newData = _this.html();   //失去焦点之后的重量
//                            var index = _this.index('.j-weight');   //获取当前点击元素的下标
                            var fmId=_this.parent().find('.j-fm-id').html();
                            var tdWeight=_this.html();
                            var fmPrimary='';
                            if(_this.next().find('input').prop('checked'))
                            {
                                fmPrimary = 1;
                            }
                            else{
                                fmPrimary = 0;
                            }

                            //判断失去焦点之后的重量和最初的重量是否不相等
                            if(oldWeight != newData )
                            {
                                $.ajax({
                                    url:"{{url('menuModifyFood')}}",
                                    data:{
                                        "_token":_token,
                                        "id":maId,
                                        "f_id":fmId,
                                        "f_weight":tdWeight,
                                        "m_primary":fmPrimary,
                                        "action":"MenuUpdateFood"
                                    },
                                    type:"POST",
                                    dataType:"json",
                                    success:function(data){
                                        refreshData();
                                        errorTips(data.message);
                                    },
                                    error:function(data){
                                        console.log(data);
                                    }
                                });
                            }
                        });
                    }

                    //函数12：改变主辅料
                    function toChangePrimary()
                    {
                        //修改主辅料
                        var bFlag = true;
                        $('#food-block').off('click').on('click','.j-primary',function(){
                            if(bFlag == false)
                            {
                                return;
                            }
                            bFlag = false;
                            var _this=$(this);
                            var fmId=_this.parent().parent().find('.j-fm-id').html();
                            var tdWeight=_this.parent().prev().html();
                            var fmPrimary='';
                            if(_this.prop('checked'))
                            {
                                fmPrimary = 1;
                            }
                            else{
                                fmPrimary = 0;
                            }
                            $.ajax({
                                url:"{{url('menuModifyFood')}}",
                                data:{
                                    "_token":_token,
                                    "id":maId,
                                    "f_id":fmId,
                                    "f_weight":tdWeight,
                                    "m_primary":fmPrimary,
                                    "action":"MenuUpdateFood"
                                },
                                type:"POST",
                                dataType:"json",
                                success:function(data){
                                    refreshData();
                                    errorTips(data.message);
                                    setTimeout(function(){
                                        bFlag = true;
                                    },1000);
                                },
                                error:function(data){
                                    console.log(data);
                                }
                            });
                        });
                    }

                    //函数13：删除一条数据
                    function toDelFood()
                    {
                        //删除数据
                        $('#j-fm-list').off('click').on('click','.j-del-fm-btn',function(){
                            var _this=$(this);
                            var fmId=_this.parent().parent().find('.j-fm-id').html();
                            layer.confirm('您确定要删除么？',{btn:['确定','取消']},
                                    function(index){
                                        $.ajax({
                                            url:"{{url('menuModifyFood')}}",
                                            data:{
                                                "_token":_token,
                                                "id":maId,
                                                "f_id":fmId,
                                                "f_weight":0,
                                                "m_primary":0,
                                                "action":"MenuDeleteFood"
                                            },
                                            type:"POST",
                                            dataType:"json",
                                            success:function(data){
                                                _this.parent().parent().remove();

                                                //重新刷新能量值
                                                refreshData();
                                                errorTips(data.message);

                                            },
                                            error:function(data){
                                                console.log(data);
                                            }
                                        });
                                        layer.close(index);
                                    },function(index){
                                        layer.close(index);
                                    }
                            );
//                            var msg = '您确定要删除么？';

//                            if(confirm(msg) == true){
//                            }else{
//                                return;
//                            }

                        });
                    }
                },
                error:function(data){
                    console.log(data);
                }
            });

        });

        //1.2-点击关闭
        closeBtn.click(function(){
            layerModify.hide();
            $('body').css("overflow","scroll");
        });

        //1.3-点击添加食材    疑点
        addFmBtn.click(function(){
            layerEditFm.show();
            $('#j-fm-name').val('');
            $('#add-f-id').val('');
            $('#j-fm-weight').val('');
        });

        //1.4-点击取消
        fmCancelBtn.click(function(){
            layerEditFm.hide();
        });

        //1.5-点击批量禁用
        var batchForbidden=$('.j-batch-forbidden');
        batchForbidden.click(function(){
            var idArr=[];
            var checkboxes=$('#j-match-list input[type=checkbox]');
            checkboxes.each(function(){
                var _this=$(this);
                if(_this.prop('checked'))
                {
                    idArr.push(_this.parent().next().html());
                }
            });

//                console.log("IDS:"+idArr);
            $.ajax({
                url:"{{url('DisableMenu')}}",
                data:{
                    "_token":_token,
                    "ids":idArr
                },
                type:"POST",
                dataType:"json",
                success:function(data){
                    checkboxes.each(function(){
                        var _this=$(this);

                        if(_this.prop('checked'))
                        {
                            _this.parent().parent().find('.is-disabled').html('×');
                            _this.parent().parent().find('.is-disabled').addClass('text-danger');
                        }
                    });
                },
                error:function(data){
                    console.log(data);
                }
            });
        });


        //------------第二部分编辑搭配详情------------------//


        selInvert();    //全选和全部选
        //2.1 添加搭配
        var addMatchMa=$('#j-add-match-ma');
        var modifyMatchMa=$('.j-modify-match-ma');
        var saveMatchMa=$('#j-save-match-ma');

        //点击添加标签按钮
        var addTagBtn=$('#j-add-tag');
        var addTagPop=$('#j-add-tag-pop');
        var cancelAddTag=$('#j-cancel-add-tag');
        var confirmAddTag=$('#j-confirm-add-tag');
        var searchTag=$('#j-search-tag');
        var tagList=$('#j-tag-list');
        var tagNameList=$('#j-tag-name-list');

        //添加标签的加号按钮
        var bC = "";
        addTagBtn.off('click').on('click',function(){
            addTagPop.show();   //添加弹框显示
            searchTag.val('');    //标签的内容清空
            searchTag.next().val('');    //标签的ID清空

            // 函数封装：搜索标签下拉菜单
            function searchTagName(Ele,oParent)
            {
                Ele.off('input propertychange').on('input propertychange',function(){

                    bC = false;
                    console.log("当进行搜索的时候"+bC);
                    var _this=$(this);
                    var tagName=_this.val();
                    if(tagName)
                    {
                        $.ajax({
                            url:"{{url('searchTag')}}",
                            data:{
                                "_token":_token,
                                "id":tagName
                            },
                            type:"POST",
                            dataType:"json",
                            success:function(data){
                                oParent.show();
                                oParent.html('');
                                if(data.status >= 0){
                                    for(var i=0; i<data.tags.length; i++)
                                    {
                                        var oTagLi=$('<li class="list-group-item hand-gesture text-muted">'+data.tags[i].tag_name+'<input type="hidden" value="'+data.tags[i].tag_id+'" /></li>');
                                        oParent.append(oTagLi);
                                    }
                                    var tagLi=oParent.find('li');
                                    tagLi.off('click').on('click',function(){
                                        bC = true;
                                        console.log("当点击完之后"+bC);
                                        var $this=$(this);
                                        _this.val($this.text());
                                        _this.next().val($this.find('input').val());
                                        oParent.hide();
                                    });
                                }
                                else{
                                    oParent.html('<li class="list-group-item">搜索结果为空</li>');
                                }
                            },
                            error:function(data){
                                console.log(data);
                            }
                        });
                    }
                });
            }

            searchTagName(searchTag,tagList);   //搜索标签下拉菜单

            console.log('过度的时候先输出'+bC);

            //确认添加标签的确定按钮
            confirmAddTag.off('click').on('click',function(){
                console.log('点击确认的时候'+bC);
                if(bC)   //如果没有点击，则断定没有从下拉选择所以不能执行
                {
                    addTagPop.hide();
                    var liTag=$('<li class="pull-left list-group-item b-a m-r-1 m-t-1 p-y-0 ">'
                            +'<span class="m-r-1 j-tag-name">'+searchTag.val()+'</span>'
                            +'<i class="fa fa-close hand-gesture j-del-tag"></i>'
                            +'<input type="hidden" value="'+searchTag.next().val()+'" class="j-tag-id" /></li>');

                    tagNameList.append(liTag);

                }else {
                    errorTips('输入不能为空');
                    return;
                }
            });

            //删除一条标签     疑点
            tagNameList.on('click','.j-del-tag',function(){
                var _this=$(this);
                _this.parent().remove();
            });

        });

        //取消添加标签按钮
        cancelAddTag.click(function(){
            addTagPop.hide();
            searchTag.val('');
            searchTag.next().val('');
        });

        //点击添加按钮的时候，给保存按钮的自定义属性赋值为1
        addMatchMa.click(function(){
            saveMatchMa.attr("data-judge",1);

            //添加心搭配之前要清空
            $('#j-code').html('');
            $('#j-edit-match-info').find('input[type=checkbox]').prop('checked',false);
            $('#j-match-name').html('');
            $('#j-match-alias').html('');
            $('#j-abstract').val('');
            $('#j-detail').val('');
            $('#j-tag-name-list').html('');
            $('#j-match-class>option').eq(0).prop('selected',true);

        });

        //点击编辑按钮的时候，给保存按钮的自定义属性赋值为0
        modifyMatchMa.off('click').on('click',function(){
            //添加心搭配之前要清空
            $('#j-edit-match-info').find('input[type=checkbox]').prop('checked',false);
            $('#j-match-name').html('');
            $('#j-match-alias').html('');
            $('#j-abstract').val('');
            $('#j-detail').val('');
            $('#j-tag-name-list').html('');
            $('#j-match-class>option').eq(0).prop('selected',true);
            saveMatchMa.attr("data-judge",0);
            var _this=$(this);
            var matchId=_this.parent().find('.j-ma-id').html();
            $.ajax({
                url:"{{url('getMenuDetail')}}",
                data:{
                    "_token":_token,
                    "id":matchId
                },
                dataType:"json",
                type:"POST",
                success:function(data){
                    console.log(data);
                    console.log(data.tag);
                    // 图片显示
                    $('#j-img-show').attr('src',data.photo);

                    //填充整个搭配详情的信息
                    $('#j-m-id').val(data.id);
                    $('#j-code').html(data.id);
                    $('#j-match-name').html(data.name);
                    $('#j-match-alias').html(data.alias);
                    jsonToData($('#j-desease-dismatch').find('input[type=checkbox]'),data.disease_dismatch);
                    jsonToData($('#j-pregnant').find('input[type=checkbox]'),data.pregnant_dismatch);
                    attrToData($('#j-desease-match').find('input[type=checkbox]'),data.disease_match);
                    attrToData($('#j-eat').find('input[type=checkbox]'),data.scene);
                    attrToData($('#j-cook').find('input[type=checkbox]'),data.type);

                    //被选中的class名
                    $('#j-match-class>option').each(function(){
                        if($(this).val() == data.class)
                        {
                            $(this).prop('selected','selected');
                        }
                    });
                    //将口味转换成被选中的状态
                    toStatus($('#j-taste').find('input[type=checkbox]'),data.taste);
                    $('#j-abstract').val(data.abstract);
                    $('#j-detail').val(toChangeLine(data.detail));
                    $('#j-match-reason').val(data.match_reason);
                    $('#j-dismatch-reason').val(data.dismatch_reason);

                    // 添加标签
                    for(var i=0; i<data.tag.length; i++)
                    {
                        var oTag =$('<li class="pull-left list-group-item b-a m-r-1 m-t-1 p-y-0 ">'
                            +'<span class="m-r-1 j-tag-name">'+data.tag[i].name+'</span>'
                            +'<i class="fa fa-close hand-gesture j-del-tag"></i>'
                            +'<input type="hidden" value="'+data.tag[i].id+'" class="j-tag-id" /></li>');

                        tagNameList.append(oTag);
                    }

                },
                error:function(){}
            });
        });

        //点击大保存，一则是添加确认；二则是修改确认
        saveMatchMa.click(function(){
            var _this=$(this);
            //保存搭配食材按钮
            toNub($('#is-forbidden'));
            var arr_dismatch=toArr($('#j-desease-dismatch').find('input[type=checkbox]'));
            var arr_match=toArr($('#j-desease-match').find('input[type=checkbox]'));
            var arr_pregnant=toArr($('#j-pregnant').find('input[type=checkbox]'));
            var arr_taste=toStr($('#j-taste').find('input[type=checkbox]'));
            var arr_scene=toArr($('#j-eat').find('input[type=checkbox]'));
            var arr_type=toArr($('#j-cook').find('input[type=checkbox]'));
            var arr_tag=toTagArr($('.j-tag-id'));
            console.log("测试"+arr_tag);
            if(_this.attr("data-judge") == 1)
            {
                //如果自定义属性为1，则说明是添加按钮
                $.ajax({
                    url:"{{url('addMenu')}}",
                    data:{
                        "_token":_token,
                        "name":$('#j-match-name').html(),
                        "alias":$('#j-match-alias').html(),
                        "class":$('#j-match-class').val(),
                        "disease_dismatch":arr_dismatch,
                        "disease_match":arr_match,
                        "pregnant_dismatch":arr_pregnant,
                        "taste":arr_taste,
                        "scene":arr_scene,
                        "type":arr_type,
                        "abstract":$('#j-abstract').val(),
                        "detail":$('#j-detail').val(),
                        "tag":arr_tag,
                        "match_reason":$('#j-match-reason').val(),
                        "dismatch_reason":$('#j-dismatch-reason').val()
                    },
                    type:"POST",
                    dataType:"json",
                    success:function(data){
                        errorTips(data.message);
                        if(data.status >= 0)
                        {
                            $('#j-code').html(data.id);
                            $('#j-m-id').val(data.id);
                        }

                    },
                    error:function(data){
                        console.log(data);
                    }
                });
            }
            else if(_this.attr("data-judge") == 0){

                //如果自定义属性为0，则说明是修改按钮
                $.ajax({
                    url:"{{url('editMenu')}}",
                    data:{
                        "_token":_token,
                        "id":$('#j-code').html(),
                        "name":$('#j-match-name').html(),
                        "alias":$('#j-match-alias').html(),
                        "class":$('#j-match-class').val(),
                        "disease_dismatch":arr_dismatch,
                        "disease_match":arr_match,
                        "pregnant_dismatch":arr_pregnant,
                        "taste":arr_taste,
                        "scene":arr_scene,
                        "type":arr_type,
                        "abstract":$('#j-abstract').val(),
                        "detail":$('#j-detail').val(),
                        "tag":arr_tag,
                        "match_reason":$('#j-match-reason').val(),
                        "dismatch_reason":$('#j-dismatch-reason').val()
                    },
                    type:"POST",
                    dataType:"json",
                    success:function(data){
                        errorTips(data.message);
                    },
                    error:function(data){
                        console.log(data);
                    }
                });
            }
        });


    }    //goToData 大函数结束


    //函数1：拼接禁忌条件
    function toJoin(data){
        //禁食疾病
        var Txt='';
        if(data)
        {
            for(var i=0; i<data.length; i++)
            {

                Txt+=data[i].name+'、';
            }
        }
        return toSub(Txt);
    }

    //函数2：将字符串的最后一个顿号去掉
    function toSub(str)
    {
        var index=str.length-1;
        str = str.substring(0,index);
        return str;
    }

    //函数3：是否禁用
    function IsValid(ele)
    {
        ele.click(function(){
            if($(this).attr('checked'))
            {
                $(this).attr('checked',false);
                $(this).val(0);
            }
            else
            {
                $(this).attr('checked',true);
                $(this).val(1);
            }
        });
    }

    //函数4：url的参数转换成json格式
    function urlToJson(url)
    {
        var json={};
        var index=url.indexOf('?');   // 存问好的索引值

        // 如果索引值为-1说明没有参数
        if(index == -1)
        {
            json={
                "class":-1,
                "energy_floor":0,
                "energy_ceil":9999,
                "m_primary_food":'',
                "name":'',
                "isvalid":0,
                "page":1
            };
        }
        else {
            var str=url.substring(index+1);   // 截取url的参数部分;
            var arr=str.split('&');   // 将参数部分用&符号分割

            for(var i=0; i<arr.length; i++)
            {
                var arr1=arr[i].split('=');
                json[arr1[0]]=arr1[1];
            }
        }
        return json;  // 返回json值
    }


    //函数5：全选和反选
    function selectAll(firEle,allEle)
    {
        firEle.click(function(){
            if($(this).prop('checked'))
            {
                allEle.prop('checked',true);
            }
            else
            {
                allEle.prop('checked',false);
            }
        });

        allEle.click(function(){
            var bAll = true;
            allEle.each(function(){
                if($(this).prop('checked') == false)
                {
                    bAll = false;
                }
            });

            if(bAll == true)
            {
                firEle.prop('checked',true);
            }
            else
            {
                firEle.prop('checked',false);
            }

        });
    }

    //函数9：请求类名
    function getClassName()
    {
        var matchClass=$('#j-class');
        var matchMaClass=$('#j-match-class');
        $.ajax({
            url:"{{url('getMenuCPST')}}",
            data:{
                "_token":_token
            },
            type:"post",
            dataType:"json",
            success:function(data){
                if(data.status == 0)
                {
                    //拼接类名
                    var op = '';
                    for(var i=0; i<data.class.length; i++)
                    {
                        if(data.class[i].id == json.class)
                        {
                            op += '<option value="'+data.class[i].id+'" selected>'+data.class[i].name+'</option>';
                        }

                        else
                        {
                            op += '<option value="'+data.class[i].id+'">'+data.class[i].name+'</option>';
                        }
                    }

                    matchClass.append(op);
                    matchMaClass.append(op);

                }
            },
            error:function(data){
                console.log(data)
            }
        });
    }


    //函数12： 错误提示
    function errorTips(str)
    {
        if($.isArray(str))
        {
            var rel='';
            for(var i=0; i<str.length; i++)
            {
                rel+=str[i]+'<br/>';
            }
            str = rel;
        }
        console.log(str);
        layer.msg(str,{time:1000});
//        alert(str);
    }


    //函数13：两数求和  疑点
    function getSum(x,y)
    {
        var m = parseFloat(x);
        var n = parseFloat(y);
        var sum = (m + n).toFixed(2);
        return sum;
    }


    //全选和全不选
    function selInvert()
    {
        var selAll=$('.j-select-all');
        selAll.click(function(){
            var _this=$(this);
            if(_this.html() == "全不选")
            {
                _this.parent().prev().find('input[type=checkbox]').prop("checked",false);
                _this.html("全选");
            }
            else if(_this.html() == "全选") {
                _this.parent().prev().find('input[type=checkbox]').prop("checked",true);
                _this.html("全不选");
            }
        });
    }

    //属性和具体的转换
    function attrToData(Eles,arr2)
    {
        if(arr2)
        {
            Eles.each(function(){
                var _this=$(this);
                for(var j=0; j<arr2.length; j++)
                {
                    if(_this.val() == arr2[j])
                    {
                        _this.prop('checked',true);
                    }
                }
            });
        }

    }

    function jsonToData(Eles,json)
    {
        Eles.each(function(){
            var _this=$(this);
            for(var name in json)
            {
                if(json[name] == _this.val())
                {
                    _this.prop('checked',true);
                }
            }
        });
    }

    //     0/1转换成是否被选中的状态
    function toStatus(Ele,str)
    {
        Ele.each(function(index){
            var _this=$(this);
            if(str.charAt(index) == 0)
            {
                _this.prop('checked',false);
                _this.val(0);
            }
            else if(str.charAt(index) == 1)
            {
                _this.prop('checked',true);
                _this.val(1);
            }
        });
    }

    //函数： 创建数组ID
    function toArr(Ele)
    {
        var arr=[];
        Ele.each(function(){
            if($(this).prop('checked'))
            {
                arr.push($(this).val());
            }
        });
        return arr;
    }

    //函数： 将口味是否被选中的状态转成字符串00100
    function toStr(Ele)
    {
        var str="";
        Ele.each(function(){
            if($(this).prop('checked'))
            {
                str+=1;
            }
            else{
                str+=0;
            }

        });
        return str;
    }

    //函数： 创建标签ID的数组
    function toTagArr(Ele)
    {
        var arr=[];
        Ele.each(function(){
            var _this=$(this);
            arr.push(_this.val());
        });
        return arr;
    }

    //函数： 将input复选框的被选中的状态所对应的值存到value中
    function toNub(Ele)
    {
        if(Ele.prop('checked'))
        {
            Ele.val(1);
        }
        else{
            Ele.val(0);
        }
    }

    //图片上传
    $('#j-img-form').ajaxForm(function(data){
        if(data.status >= 0){
            $('#j-img-show').attr('src', data.src);//上传成功后，替换图片路径
            console.log(data)
        }else{
            console.log(data)
        }
    });

    $('#j-up-img').change(function(){
        $('#j-img-form').submit();

    });

    // 将字符串按照分号换行
    function toChangeLine(str){
        str = str.replace(/\；/g,'；\n');

        return str;
    }

</script>
@endsection
